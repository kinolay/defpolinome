import psycopg2
from datetime import date
import numpy as np
import json

# Создание таблицы
connection = psycopg2.connect(host='127.0.0.1', port='5432', database = 'testdb',  user = 'postgres', password = '123456')
cursor = connection.cursor()
create_table = """CREATE TABLE IF NOT EXISTS function_runs (
id SERIAL PRIMARY KEY,
launch_date DATE NOT NULL,
function_name TEXT NOT NULL,
function_arguments JSONB,
function_result JSONB,
error_text TEXT
)
"""
cursor.execute(create_table_query)


def save_execution_result(x, y, degree):

    coefficients, intercept, predict = polynomial_regression(x, y, degree)

    connection = psycopg2.connect(host='127.0.0.1', port='5432', database = 'testdb',  user = 'postgres', password = '123456')
    cursor = connection.cursor()
    print("Подключение установлено")

    execution_date = date.today()
    function_name = "polynomial_regression"
    function_arguments = json.dumps({"x": x.tolist(), "y": y.tolist(), "degree": degree})
    function_results = json.dumps({"coef": coefficients.tolist(), "intercept": str(intercept), "predict": pred.tolist()})
    error_message = ""

    try:
        # Добавление данных
        insert_query = "INSERT INTO function_runs (launch_date, function_name, function_arguments, function_result, error_text) VALUES (%s, %s, %s, %s, %s);"
        cursor.execute(insert_query, (execution_date, function_name, function_arguments, function_results, error_message,))
        connection.commit()
        print("save")

    except Exception as e:
        error_message = str(e)
        connection.rollback()

    finally:
        cursor.close()
        connection.close()

# Пример использования
a = np.array([[13], [66], [-3], [-99], [22], [38], [57], [-85], [-92], [85]])
b = np.array([27, 6, 72, 4, 7, -86, -10, 24, -14, -92])

save_execution_result(a, b, 5)
